46/4b67/parentItemCode_caneOfSomaria_46: |
  /copy a,$06,$0b67,$1b

# itemCode04 at ages 07:5c49
47/5c49/itemCode04_47: /copy a,$07,$1c49,$63
# itemCode18 at ages 07:5cac
47/5cac/itemCode18_47: |
  /copy a,$07,$1cac,$13f
  
  push hl
  ld e,$46
  ld hl,getSomariaBlockIndex
  call interBankCall
  pop hl
  ld a,(hl)
  cp b
  
  /copy a,$07,$1dee,$0e
  
  call $15c5 ; getTileIndexFromRoomLayoutBuffer
  jp $3a52 ; setTile
  ; skip patch's room handling
  db $00,$00,$00,$00,$00
  
  /copy a,$07,$1e10,$2d
  jr c,$0d
  
  push hl
  ld e,$46
  ld hl,getSomariaBlockIndex
  call interBankCall
  pop hl
  ld a,(hl)
  ld (hl),b
  ld b,a
  
  /copy a,$07,$1e42,$18

# parentItemCode_caneOfSomaria adjustments
46/4b6f/: call $2aab ; updateLinkDirectionFromAngle

# itemCode04 adjustments
47/5c56/: ld a,$38; UNCMP_GFXH_AGES_1c > $38
47/5c58/: call $165b ; loadWeaponGfx
47/5c60/: call playSound
47/5c67/: jp $1e27 ; objectSetVisible82
47/5c70/: call $23a5 ; itemIncState
47/5c75/: call $2274 ; findItemWithID
47/5c90/: call $2c40 ; getFreeItemSlot

# itemCode18 adjustments
47/5cbd/: call $5e5c ; @alignOnTile
47/5cc7/: call $23a5 ; itemIncState
47/5ccc/: call playSound
47/5ccf/: jp $1e30 ; objectSetVisible83
47/5cd2/: call $5e10 ; @checkBlockCanAppear
47/5ced/: call $5e10 ; @checkBlockCanAppear
47/5d19/: call $23aa ; itemIncSubState
47/5d1c/: call $2c37 ; itemUpdateAngle
# 47/5d22/: ld a,(wBraceletLevel) TODO : when bracelet 2 is implemented, change that
47/5d22/: |
  ld a,$01
  nop
47/5d34/: call playSound
47/5d37/: call $5dfe ; @removeBlock
47/5d44/: call $1fdb ; objectApplySpeed
47/5d4a/: call $2391 ; itemDecCounter1
47/5d56/: call $5dfe ; @removeBlock
47/5d5e/: call $24ad ; objectCreatePuff
47/5d61/: jp $2c29 ; itemDelete
47/5d70/: call $23aa ; itemIncSubState
47/5d73/: call $5dfe ; @removeBlock
47/5d76/: call $1dfa ; objectSetVisiblec1
47/5d82/: call $2b8a ; dropLinkHeldItem
47/5d87/: call $215d ; objectCheckWithinRoomBoundary
47/5dae/: ld a,($ccb3) ; (wActiveTilePos)
47/5db6/: ld a,($cc50) ; (wTilesetFlags)
47/5dcc/: jp z,$2b75 ; objectAddToGrabbableObjectBuffer
47/5dd1/: jp $29c5 ; itemSetState
47/5de2/: jp $1d3d ; preventObjectHFromPassingObjectD

47/5e18/: call $149b ; objectGetTileCollisions
47/5e1c/: ld a,($cc50) ; (wTilesetFlags)
47/5e2f/: |
  call $5e5c ; @alignOnTile
  call $1432 ; objectGetTileAtPosition
47/5e36/: |
  ld hl,$23c3 ; hazardCollisionTable
  call $1ddd ; lookupCollisionTable

47/5e55/: call $1414 ; setTileInRoomLayoutBuffer
47/5e5c/: call $2099 ; objectCenterOnTile

06//parentItemCode_caneOfSomaria: |
  ld hl,parentItemCode_caneOfSomaria_46
  call_bank_46:
  ld e,$46
  jp interBankCall

07//itemCode04: |
  ld hl,itemCode04_47
  call_bank_47:
  ld e,$47
  jp interBankCall

07//itemCode18: |
  ld hl,itemCode18_47
  jr call_bank_47

# Update parentItemUpdate table
06/49af/: dw parentItemCode_caneOfSomaria

07/48b2/: dw itemCode04
07/48da/: dw itemCode18

# Update item usage table
06/5510/: db $03

# nextToPushableBlock with somaria block
06/413b/: |
  ld e,$46
  ld hl,nextToPushableBlock_checkSomaria
  jp interBankCall
  nop
  nop
  ld h,$d1

46/4141/nextToPushableBlock_checkSomaria: |
  call getSomariaBlockIndex
  ldh a,($8b)
  cp b
  /copy a,$06,$0145,$0e
  ld e,$06
  ld hl,$4145
  jp interBankCall

46/4174/: |
  @end_call:
  ld e,$06
  ld hl,$415e
  jp interBankCall
  @end:
  jr @end_call

46/4180/@somariaBlock: |
  /copy a,$06,$017e,$13
46/4182/: call $2274
46/418b/: ld a,($cc80) ; (wLinkPushingDirection)

# tryToBreakTile_body, close to @doneSettingTile
06/4777/: |
  ld e,$46
  ld hl,tryToBreakTile_body@doneSettingTile
  call interBankCall
  jp (hl)
  nop

46/47a0/tryToBreakTile_body@doneSettingTile: |
  call getSomariaBlockIndex
  ldh a,($92)
  cp b
  /copy a,$06,$07a6,$0a
  ld hl,$4781
  ret

46/47b3/getSomariaBlockIndex: |
  ld a,($cc4f) ; wActiveCollisions
  ld b,$3f ; Overworld
  or a
  ret z
  dec a ; Subrosia
  ld b,$ba
  ret z
  dec a ; Maku Tree (2)
  ld b,$3f
  ret z
  ; Indoors (3), Dungeon (4), Sidescrolling (5)
  ld b,$f9
  ret

46/47e6/tryToBreakTile_body@done: |
  ld hl,$47b8
  ret
  /copy a,$06,$07ea,$1f

46/47ec/: call $2274 ; findItemWithID
46/47ef/: jr nz,$f5 ; move @done backwards to fit a ld hl
46/47f4/: call $227b ; findItemWithID_startingAfterH
46/47f7/: jr nz,$ed ; move @done backwards to fit a ld hl
46/47fc/: jr $e8 ; move @done backwards to fit a ld hl

# edit somaria block interactableTilesTable
06/43a5/: |
  dw interactableTilesTable@subrosia
  dw $43c1
  dw $43c7
  dw $43c7
  dw $43c1
06/43c1/: db $3f,$80,$00,$00,$00,$00,$f9,$80
06//interactableTilesTable@subrosia: |
  /copy s,$06,$03c2,$06
  db $ba,$80,$00

# edit breakableTileCollisionTable
06/75c2/: |
  dw $7645
  dw $75ce
  dw $76b6
  dw $76b6
  dw $76e7

06/7642/: |
  ; overworld / maku
  db $3f,$30
  db $0
  
  ; subrosia
  db $ba,$30
  /copy s,$06,$3643,$6f
  
  ; indoors / dungeons
  db $f9,$30
  /copy s,$06,$36b2,$2f
  
  ; sidescrolling
  db $f9,$30
  /copy s,$06,$36e1,$03

  ; breakableTileModes
  /copy s,$06,$36e4,$f0
  /copy a,$06,$39d7,$05 ; add collision $30

# move breakableTileModes reference
06/4734/: db $ec

## edit somaria block objectCollisionTable
# copy ENEMYCOLLISION_PROJECTILE 0x06 (seasons) from ENEMYCOLLISION_PROJECTILE 0x06 (ages)
07/6b63/: /copy a,$07,$2ddf,$01
# copy ENEMYCOLLISION_PROJECTILE_WITH_RING_MOD 0x07 (seasons) from ENEMYCOLLISION_PROJECTILE_WITH_RING_MOD 0x07 (ages)
07/6b83/: /copy a,$07,$2dff,$01
# copy ENEMYCOLLISION_MERGED_TWINROVA 0x08 (seasons) from ENEMYCOLLISION_MERGED_TWINROVA 0x08 (ages)
07/6ba3/: /copy a,$07,$2e1f,$01
# copy ENEMYCOLLISION_TWINROVA 0x0a (seasons) from ENEMYCOLLISION_TWINROVA 0x0a (ages)
07/6be3/: /copy a,$07,$2e5f,$01
# copy ENEMYCOLLISION_GANON 0x0b (seasons) from ENEMYCOLLISION_GANON 0x0b (ages)
07/6c03/: /copy a,$07,$2e7f,$01
# copy ENEMYCOLLISION_KING_MOBLIN 0x0e (seasons) from ENEMYCOLLISION_KING_MOBLIN 0x50 (ages)
07/6c63/: /copy a,$07,$371f,$01
# copy ENEMYCOLLISION_MOTIONLESS_ENEMY 0x0f (seasons) from ENEMYCOLLISION_MOTIONLESS_ENEMY 0x0f (ages)
07/6c83/: /copy a,$07,$2eff,$01
# copy ENEMYCOLLISION_STANDARD_ENEMY 0x10 (seasons) from ENEMYCOLLISION_STANDARD_ENEMY 0x10 (ages)
07/6ca3/: /copy a,$07,$2f1f,$01
# copy ENEMYCOLLISION_BURNABLE_ENEMY 0x11 (seasons) from ENEMYCOLLISION_BURNABLE_ENEMY 0x11 (ages)
07/6cc3/: /copy a,$07,$2f3f,$01
# copy ENEMYCOLLISION_LYNEL 0x12 (seasons) from ENEMYCOLLISION_LYNEL 0x12 (ages)
07/6ce3/: /copy a,$07,$2f5f,$01
# copy ENEMYCOLLISION_BLADE_TRAP 0x13 (seasons) from ENEMYCOLLISION_BLADE_TRAP 0x13 (ages)
07/6d03/: /copy a,$07,$2f7f,$01
# copy ENEMYCOLLISION_GIBDO 0x15 (seasons) from ENEMYCOLLISION_GIBDO 0x16 (ages)
07/6d43/: /copy a,$07,$2fdf,$01
# copy ENEMYCOLLISION_SPARK 0x16 (seasons) from ENEMYCOLLISION_SPARK 0x17 (ages)
07/6d63/: /copy a,$07,$2fff,$01
# copy ENEMYCOLLISION_SPIKED_BEETLE 0x17 (seasons) from ENEMYCOLLISION_SPIKED_BEETLE 0x18 (ages)
07/6d83/: /copy a,$07,$301f,$01
# copy ENEMYCOLLISION_BUBBLE 0x18 (seasons) from ENEMYCOLLISION_BUBBLE 0x19 (ages)
07/6da3/: /copy a,$07,$303f,$01
# copy ENEMYCOLLISION_GHINI 0x19 (seasons) from ENEMYCOLLISION_GHINI 0x1a (ages)
07/6dc3/: /copy a,$07,$305f,$01
# copy ENEMYCOLLISION_BUZZBLOB 0x1a (seasons) from ENEMYCOLLISION_BUZZBLOB 0x1b (ages)
07/6de3/: /copy a,$07,$307f,$01
# copy ENEMYCOLLISION_WHISP 0x1b (seasons) from ENEMYCOLLISION_WHISP 0x1c (ages)
07/6e03/: /copy a,$07,$309f,$01
# copy ENEMYCOLLISION_IRON_MASK 0x1c (seasons) from ENEMYCOLLISION_IRON_MASK 0x1d (ages)
07/6e23/: /copy a,$07,$30bf,$01
# copy ENEMYCOLLISION_ACTIVE_RED_ARMOS 0x1d (seasons) from ENEMYCOLLISION_ACTIVE_RED_ARMOS 0x1e (ages)
07/6e43/: /copy a,$07,$30df,$01
# copy ENEMYCOLLISION_DARKNUT 0x1f (seasons) from ENEMYCOLLISION_DARKNUT 0x20 (ages)
07/6e83/: /copy a,$07,$311f,$01
# copy ENEMYCOLLISION_BURNABLE_UNDEAD 0x20 (seasons) from ENEMYCOLLISION_BURNABLE_ENEMY 0x11 (ages)
07/6ea3/: /copy a,$07,$2f3f,$01
# copy ENEMYCOLLISION_POLS_VOICE 0x21 (seasons) from ENEMYCOLLISION_POLS_VOICE 0x21 (ages)
07/6ec3/: /copy a,$07,$313f,$01
# copy ENEMYCOLLISION_LIKE_LIKE 0x22 (seasons) from ENEMYCOLLISION_LIKE_LIKE 0x22 (ages)
07/6ee3/: /copy a,$07,$315f,$01
# copy ENEMYCOLLISION_GOPONGA_FLOWER 0x23 (seasons) from ENEMYCOLLISION_GOPONGA_FLOWER 0x23 (ages)
07/6f03/: /copy a,$07,$317f,$01
# copy ENEMYCOLLISION_WALLMASTER 0x24 (seasons) from ENEMYCOLLISION_WALLMASTER 0x25 (ages)
07/6f23/: /copy a,$07,$31bf,$01
# copy ENEMYCOLLISION_GIANT_BLADE_TRAP 0x25 (seasons) from ENEMYCOLLISION_GIANT_BLADE_TRAP 0x26 (ages)
07/6f43/: /copy a,$07,$31df,$01
# copy ENEMYCOLLISION_THWIMP 0x26 (seasons) from ENEMYCOLLISION_THWIMP 0x27 (ages)
07/6f63/: /copy a,$07,$31ff,$01
# copy ENEMYCOLLISION_THWOMP 0x27 (seasons) from ENEMYCOLLISION_THWOMP 0x28 (ages)
07/6f83/: /copy a,$07,$321f,$01
# copy ENEMYCOLLISION_UNDEAD 0x28 (seasons) from ENEMYCOLLISION_STANDARD_ENEMY 0x10 (ages)
07/6fa3/: /copy a,$07,$2f1f,$01
# copy ENEMYCOLLISION_KEESE 0x29 (seasons) from ENEMYCOLLISION_KEESE 0x1f (ages)
07/6fc3/: /copy a,$07,$30ff,$01
# copy ENEMYCOLLISION_ZOL 0x2a (seasons) from ENEMYCOLLISION_ZOL 0x29 (ages)
07/6fe3/: /copy a,$07,$323f,$01
# copy ENEMYCOLLISION_CUCCO 0x2b (seasons) from ENEMYCOLLISION_CUCCO 0x2a (ages)
07/7003/: /copy a,$07,$325f,$01
# copy ENEMYCOLLISION_FIRE_KEESE 0x2c (seasons) from ENEMYCOLLISION_FIRE_KEESE 0x2b (ages)
07/7023/: /copy a,$07,$327f,$01
# copy ENEMYCOLLISION_GIANT_CUCCO 0x2d (seasons) from ENEMYCOLLISION_GIANT_CUCCO 0x2c (ages)
07/7043/: /copy a,$07,$329f,$01
# copy ENEMYCOLLISION_PEAHAT_VULNERABLE 0x2e (seasons) from ENEMYCOLLISION_PEAHAT_VULNERABLE 0x2e (ages)
07/7063/: /copy a,$07,$32df,$01
# copy ENEMYCOLLISION_CROW 0x30 (seasons) from ENEMYCOLLISION_CROW 0x31 (ages)
07/70a3/: /copy a,$07,$333f,$01
# copy ENEMYCOLLISION_GEL 0x31 (seasons) from ENEMYCOLLISION_GEL 0x33 (ages)
07/70c3/: /copy a,$07,$337f,$01
# copy ENEMYCOLLISION_PINCER 0x32 (seasons) from ENEMYCOLLISION_PINCER 0x34 (ages)
07/70e3/: /copy a,$07,$339f,$01
# copy ENEMYCOLLISION_GOHMA_GEL 0x33 (seasons) from ENEMYCOLLISION_GOHMA_GEL 0x35 (ages)
07/7103/: /copy a,$07,$33bf,$01
# copy ENEMYCOLLISION_SWORD_MASKED_MOBLIN 0x34 (seasons) from ENEMYCOLLISION_SWORD_MASKED_MOBLIN 0x36 (ages)
07/7123/: /copy a,$07,$33df,$01
# copy ENEMYCOLLISION_BALL_AND_CHAIN_SOLDIER 0x35 (seasons) from ENEMYCOLLISION_BALL_AND_CHAIN_SOLDIER 0x37 (ages)
07/7143/: /copy a,$07,$33ff,$01
# copy ENEMYCOLLISION_HARDHAT_BEETLE 0x36 (seasons) from ENEMYCOLLISION_HARDHAT_BEETLE 0x38 (ages)
07/7163/: /copy a,$07,$341f,$01
# copy ENEMYCOLLISION_ARM_MIMIC 0x37 (seasons) from ENEMYCOLLISION_ARM_MIMIC 0x39 (ages)
07/7183/: /copy a,$07,$343f,$01
# copy ENEMYCOLLISION_MOLDORM 0x38 (seasons) from ENEMYCOLLISION_MOLDORM 0x3a (ages)
07/71a3/: /copy a,$07,$345f,$01
# copy ENEMYCOLLISION_BEETLE 0x39 (seasons) from ENEMYCOLLISION_BEETLE 0x3b (ages)
07/71c3/: /copy a,$07,$347f,$01
# copy ENEMYCOLLISION_TWINROVA_BAT 0x3f (seasons) from ENEMYCOLLISION_TWINROVA_BAT 0x41 (ages)
07/7283/: /copy a,$07,$353f,$01
# copy ENEMYCOLLISION_VIRE 0x45 (seasons) from ENEMYCOLLISION_VIRE 0x46 (ages)
07/7343/: /copy a,$07,$35df,$01
# copy ENEMYCOLLISION_SPIKED_BEETLE_FLIPPED 0x4e (seasons) from ENEMYCOLLISION_SPIKED_BEETLE_FLIPPED 0x51 (ages)
07/7463/: /copy a,$07,$373f,$01
# copy ENEMYCOLLISION_UNMASKED_IRON_MASK 0x50 (seasons) from ENEMYCOLLISION_UNMASKED_IRON_MASK 0x53 (ages)
07/74a3/: /copy a,$07,$377f,$01
# copy ENEMYCOLLISION_ACTIVE_BLUE_ARMOS 0x51 (seasons) from ENEMYCOLLISION_ACTIVE_BLUE_ARMOS 0x54 (ages)
07/74c3/: /copy a,$07,$379f,$01
# copy ENEMYCOLLISION_STALFOS_BLOCKED_WITH_SWORD 0x52 (seasons) from ENEMYCOLLISION_STALFOS_BLOCKED_WITH_SWORD 0x55 (ages)
07/74e3/: /copy a,$07,$37bf,$01
# copy ENEMYCOLLISION_DARKNUT_BLOCKED_WITH_SWORD 0x53 (seasons) from ENEMYCOLLISION_DARKNUT_BLOCKED_WITH_SWORD 0x56 (ages)
07/7503/: /copy a,$07,$37df,$01
# copy ENEMYCOLLISION_BIG_GOPONGA_FLOWER 0x54 (seasons) from ENEMYCOLLISION_BIG_GOPONGA_FLOWER 0x57 (ages)
07/7523/: /copy a,$07,$37ff,$01
# copy ENEMYCOLLISION_SPIKED_BALL 0x6b (seasons) from ENEMYCOLLISION_SPIKED_BALL 0x74 (ages)
07/7803/: /copy a,$07,$3b9f,$01
# copy ENEMYCOLLISION_GANON_TRIDENT 0x70 (seasons) from ENEMYCOLLISION_GANON_TRIDENT 0x7b (ages)
07/78a3/: /copy a,$07,$3c7f,$01

# edit enemyActiveCollisions (using Stewmat's enemy active collision table)
07/6746/: db $f8
07/674a/: db $78
07/674e/: db $78
07/6752/: db $78
07/6756/: db $78
07/675a/: db $f8
07/6762/: db $f8
07/6766/: db $f8
07/676a/: db $f8
07/676e/: db $f8
07/6772/: db $f8
07/6776/: db $f8
07/677a/: db $78
07/677e/: db $78
07/6782/: db $f8
07/678a/: db $f8
07/678e/: db $78
07/6792/: db $f8
07/6796/: db $78
07/679e/: db $f8
07/67a2/: db $f8
07/67a6/: db $78
07/67aa/: db $f8
07/67ae/: db $f8
07/67b2/: db $f8
07/67b6/: db $f8
07/67ba/: db $f8
07/67c2/: db $f8
07/67c6/: db $f8
07/67ca/: db $f8
07/67ce/: db $f8
07/67d2/: db $f8
07/67d6/: db $f8
07/67e2/: db $f8
07/67ea/: db $78
07/67f2/: db $f8
07/67fa/: db $78
07/67fe/: db $78
07/6802/: db $f8
07/6806/: db $f8
07/680a/: db $f8
07/6812/: db $f8
07/6816/: db $f8
07/681a/: db $f8
07/6826/: db $f8
07/682a/: db $f8
07/682e/: db $f8
07/6832/: db $78
07/6836/: db $f8
07/683a/: db $f8
07/6846/: db $f8
07/684e/: db $f8
07/6856/: db $f8
07/685a/: db $f8
07/685e/: db $f8
07/6862/: db $f8
07/6866/: db $f8
07/686a/: db $f8
07/686e/: db $f8
07/6872/: db $f8
07/6876/: db $f8
07/687a/: db $f8
07/687e/: db $f8
07/6886/: db $f8
07/688a/: db $f8
07/6896/: db $78
07/689a/: db $f8
07/68ba/: db $f8
07/6902/: db $f8
07/690a/: db $f8
07/690e/: db $f8
07/6912/: db $f8
07/6916/: db $f8
07/691a/: db $f8
07/691e/: db $78
07/6922/: db $f8
07/6926/: db $78
07/692a/: db $f8
07/692e/: db $78
07/6932/: db $78
07/6936/: db $f8
07/693a/: db $f8
07/693e/: db $78

# edit partActiveCollisions (using Stewmat's part active collision table)
07/69ea/: db $78
07/6a7e/: db $f8
07/6a82/: db $08

# Change sndMysterySeed priority
39/55cc/sndMysterySeed: db $32

# clearAllItemsAndPutLinkOnGround
00//clearSomariaBlock: |
  /copy a,$00,$19bc,$05
  jr nz,@notSomariaBlock
  /copy a,$00,$19c3,$0a
  jp $199b
  @notSomariaBlock:
  /copy a,$00,$19cf,$03
  ret

00/1995/:
  call clearSomariaBlock

# Make somaria cane not cut grass
# To do that, only cut grass when it's a sword instead of not cutting it when it's the rod
07/5d50/: |
  cp $05
  db $20 ; replaces jr z by jr nz

# gfx
1b/7ac0/: /copy a,$19,$02e0,$20
# Apply the sprite to the inventory item by changing the treasureDisplayData
3f/6dbe/: db $a5
# Add the gfx entry to the interactionData
3f/67f6/: db $61,$0a,$20 ; GFX_5e
# Replace the L-1 and L-2 ring box inventory text
1d/72b0/TX_091e: |
  db $43,$61,$6e,$65,$03,$e3,$53,$6f
  db $6d,$61,$72,$69,$61,$01,$55,$73
  db $65,$64,$03,$b0,$63,$04,$09,$65
  db $01,$62,$05,$a6,$73,$2e,$00
# TreasureDisplayData
3f/6dc3/: db $1d
# treasureObjectData
15/513b/: db $b2,$5e

# Remove the grass effect on the somaria block indoors
00/0f39/: |
  call checkSomariaGrass
  jr c,$10 ; @end
00//checkSomariaGrass: |
  cp $f9
  jr nz,@end
  ld a,(wActiveGroup)
  cp $02
  ccf
  ret c
  
  @end:
  and a ; sets c to 0
  bit 2,h
  ld a,($cc52) ; wGrassAnimationModifier
  ret